# Infos about the state of the project

## Power supply

CubeMX didn't have the previously used DIRECT_SMPS option when selecting power supply, LDO was used. When using this the application couldn't run. I copied over the previously used power supply configuration to the source code.

## Generated makefile

When generating the project, I edited the generated makefile, and it seems like modifications and regeneration didn't replace these changes, so the makefile might not be the same that would be generated by default.

## Syscalls.h and sysmem.h

When generating the MX project with FreeRTOS, these two files were added in the makefile as sources of the project, without adding the actual files. Of course the project didn't build without them. They contain posix system calls, some from the `man syscalls` page. These functions can also be found in `unistd.h` (this file can be found in the arm-none-eabi include folder).

After searching for places where any of the functions can be called in the project or where the files would be included, I deleted these files (I didn't find any call or include).

Then after reading about newlib, I found out that these are required for most of the standard library functions. Basic implementation can be provided by using `--specs=nosys` or linking against `nosys` static lib? (I didn't test these).

So to provide the basic implementations, I added the files from a previous project. Some of the functions are implemented in `heap_useNewlib_ST.c`. Also write is modified to support printf. This is not yet reentrant but can be as mentioned in `notes`.

### IMPORTANT

Due to how sbrk works, if I later add a custom section for the shared variables, then the end of the stack (_end symbol) should be updated, because heap allocation starts from there.

## CMSIS lib

When updating the previously problematic cache invalidation function, only replaced this part of the file and didn't update anything else.

## FreeRTOS version

Updated the OS to 11.0.1.

## Serial communication

tio can be used

### On the microcontroller

Printf calls the _write implementation that is not yet reentrant. In the MX config I started the timer right away. Printf support is enabled by the `-u _printf_float` linker flag, the same can be done for sprintf with a similar flag. Nothing is done for printf on the M4 currently.

#### ERROR with serial com:

Printf with float caused a hard fault when only two task was running on the CM7 core. In the AI task the printf worked without problem, inside the default task it failed. One of the differences was the stack size. After increasing the task size of the default task, the problem was solved. Although stack checking is turned in in FreeRTOS, it didn't catch the error this time (it worked before, so this was just a less detectable problem).

## Systick timer

HAL and FreeRTOS can both be used with systick interrupt, but this may cause problems. Probably stopping the systick also ruins the other. HAL lib may depend on this timer and this can cause problems in the OS. (google search lists the problems probably)

* So the OS uses the systick, for this the systick interrupt is required (see defines at the end of `FreeRTOSConfig.h`).
* HAL uses different basic timers.

## Choosing a timer to measure time

The high precision timer can be used to generate accurate waverforms and other accurate timing related tasks. It can run from the core1 clock and is only 16 bits wide. The maximum length measured is roughly 100 us. Dividing it defeats the purpose of the high precision.

TIM5 and TIM2 are general purpose timer, these can be 32 bits. The maximum measured time (with max clk) is around 18 seconds. The clock can be 240 MHz max, so the preciosion is still great using general purpose timers.
